#!/bin/bash
set -euo pipefail

REPLSET=rs01

# Wait for MongoDB
for i in {1..60}; do
  if mongosh --quiet --eval 'db.runCommand({ ping: 1 })' >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

# Init replica set once
if mongosh --quiet --eval 'rs.status().ok' >/dev/null 2>&1; then
  exit 0
fi

echo "Initializing MongoDB replica set..."

mongosh --quiet <<EOF
rs.initiate({
  _id: "$REPLSET",
  members: [{ _id: 0, host: "127.0.0.1:27017" }]
})
EOF
